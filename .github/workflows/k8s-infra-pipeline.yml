name: K8s Infra Pipeline
run-name: "${{ inputs.command }} ${{ inputs.cloud }}/${{ inputs.environment }}"

on:
  workflow_dispatch:
    inputs:
      command:
        description: OpenTofu command to run (plan, apply, destroy)
        required: true
        default: plan
        type: choice
        options:
          - plan
          - apply
          - destroy
      cloud:
        description: Cloud to deploy to
        required: true
        default: digitalocean
        type: choice
        options:
          - digitalocean
          - aws
      environment:
        description: Environment to deploy to
        required: true
        default: dev
        type: choice
        options:
          - dev

jobs:
  terraform:
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # Required for OIDC authentication
      contents: read    # Required to checkout code
    defaults:
      run:
        working-directory: clouds/${{ inputs.cloud }}/environments/${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.8.0

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: us-east-2

      - name: Configure cloud credentials and Terraform variables
        run: |
          echo "DIGITALOCEAN_TOKEN=${{ secrets.DIGITALOCEAN_TOKEN }}" >> $GITHUB_ENV
          echo "TF_VAR_digitalocean_token=${{ secrets.DIGITALOCEAN_TOKEN }}" >> $GITHUB_ENV
          echo "TF_VAR_database_url=${{ secrets.TF_VAR_DATABASE_URL }}" >> $GITHUB_ENV
          echo "TF_VAR_supabase_url=${{ secrets.TF_VAR_SUPABASE_URL }}" >> $GITHUB_ENV
          echo "TF_VAR_supabase_anon_key=${{ secrets.TF_VAR_SUPABASE_ANON_KEY }}" >> $GITHUB_ENV
          echo "TF_VAR_supabase_jwt_secret=${{ secrets.TF_VAR_SUPABASE_JWT_SECRET }}" >> $GITHUB_ENV
          echo "TF_VAR_letsencrypt_email=${{ secrets.TF_VAR_LETSENCRYPT_EMAIL }}" >> $GITHUB_ENV
          echo "TF_VAR_ghcr_username=${{ secrets.TF_VAR_GHCR_USERNAME }}" >> $GITHUB_ENV
          echo "TF_VAR_ghcr_token=${{ secrets.TF_VAR_GHCR_TOKEN }}" >> $GITHUB_ENV
          echo "TF_VAR_aws_access_key_id=${{ secrets.TF_VAR_AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "TF_VAR_aws_secret_access_key=${{ secrets.TF_VAR_AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          # Grafana Cloud observability
          echo "TF_VAR_grafana_cloud_prometheus_url=${{ secrets.TF_VAR_GRAFANA_CLOUD_PROMETHEUS_URL }}" >> $GITHUB_ENV
          echo "TF_VAR_grafana_cloud_prometheus_username=${{ secrets.TF_VAR_GRAFANA_CLOUD_PROMETHEUS_USERNAME }}" >> $GITHUB_ENV
          echo "TF_VAR_grafana_cloud_loki_url=${{ secrets.TF_VAR_GRAFANA_CLOUD_LOKI_URL }}" >> $GITHUB_ENV
          echo "TF_VAR_grafana_cloud_loki_username=${{ secrets.TF_VAR_GRAFANA_CLOUD_LOKI_USERNAME }}" >> $GITHUB_ENV
          echo "TF_VAR_grafana_cloud_access_token=${{ secrets.TF_VAR_GRAFANA_CLOUD_ACCESS_TOKEN }}" >> $GITHUB_ENV
          # Grafana Cloud dashboard and alerting management
          echo "TF_VAR_grafana_cloud_stack_url=${{ secrets.TF_VAR_GRAFANA_CLOUD_STACK_URL }}" >> $GITHUB_ENV
          echo "TF_VAR_grafana_cloud_service_account_token=${{ secrets.TF_VAR_GRAFANA_CLOUD_SERVICE_ACCOUNT_TOKEN }}" >> $GITHUB_ENV
          echo "TF_VAR_alert_email=${{ secrets.TF_VAR_ALERT_EMAIL }}" >> $GITHUB_ENV

      - name: Initialize OpenTofu
        run: tofu init

      - name: Run OpenTofu command
        run: |
          if [ "${{ inputs.command }}" = "plan" ]; then
            tofu plan
          else
            tofu ${{ inputs.command }} -auto-approve
          fi
